title: elasticsearch + logstash + kibana3
date: 2014-11-27 23:27:06
tags: log
---



## 目的 ##

搭建该平台的目的就是为了运维、研发很方便的进行日志的查询


## 简介 ##

1. logstsh

	![](http://i2.tietuku.com/ee102b9bc74b5a7f.jpg)
	
	- 收集日志转到任意地方
	- inputs >> codecs >> filters >> outputs
	- 支持的插件（很多 [官网](http://logstash.net/docs/1.4.2/)）
	- ruby

2. ElasticSearch 

	![](http://i2.tietuku.com/57191356d5bde5a5.jpg)
	
	- 基于lucene的开源搜索引擎
	- 实时、分布式、高可用、文档型、restful api
	- java

3. kibana

	![](http://i2.tietuku.com/28241ba7923d65b8.jpg)

	- kibana是一个功能强大的elasticsearch数据显示客户端
	- 纯html+js客户端，可以很方便的部署到Apache、Nginx等Http服务器
	- [酷图](https://trash.ulyaoth.net/trash/png/logstash/geoip/logstashgeoip.png)	


## 架构图 ##

![](http://static.oschina.net/uploads/space/2013/1128/134318_n6Bp_123777.jpg)


## 安装 ##
依赖jdk
安装过程参考 

- [linux]([http://enable.blog.51cto.com/747951/1049411](http://enable.blog.51cto.com/747951/1049411))
- [windows](https://community.ulyaoth.net/threads/how-to-install-logstash-on-a-windows-server-with-kibana-in-iis.17/)


## 实例 ##

标注输入

	input {
	  stdin{}
	}
	
	filter {
	  grok {
	    match => [ "message", "(?<ttt>\d{1,3})" ]
	  }
	}
	
	output{
	 stdout{
	   codec => rubydebug
	 }
	}

输入结果

![](http://i2.tietuku.com/2bed88a0e407f62d.png)

nginx 访问日志

nginx 配置

	http {
			log_format logstash_json '{ "@timestamp": "$time_iso8601", '
			                         '"@fields": { '
			                         '"remote_addr": "$remote_addr", '
			                         '"remote_user": "$remote_user", '
			                         '"body_bytes_sent": "$body_bytes_sent", '
			                         '"request_time": "$request_time", '
			                         '"status": "$status", '
			                         '"request": "$request", '
			                         '"request_method": "$request_method", '
			                         '"http_referrer": "$http_referer", '
			                         '"http_user_agent": "$http_user_agent" } }';
	}
   
    server {
		access_log /var/log/nginx/xiaoma.log logstash_json;
	}
	


 nginx-access-json.conf


	input{
	  file {
	     path => "/usr/local/logstash/conf/xiaoma.log"
	     type => "nginx_json"
	     start_position => "beginning"
	     format => "json_event"
	     sincedb_path => "/dev/null"
	  }
	}
	
	filter {
	  if [type] == "nginx_json" {
	     geoip {
	       source => "remote_addr"
	     }
	  }
	}
	output{
	   stdout{
	       codec => rubydebug
	   }
	
	   elasticsearch {
	        host => "127.0.0.1"
	   }
	}


输入结果

![](http://i2.tietuku.com/fa89dc8f73e5c621.png)

mysql慢查询

	input {
	  file {
	    type => "mysql-slow"
	    path => "/usr/local/src/mysql-slow.log"
	    start_position => "beginning"
	  }
	}
	
	filter {
	      grep {
	        match => [ "@message", "^# Time: " ]
	        negate => true
	      }
	
	      grok {
	        singles => true
	        pattern => [
	          "^# User@Host: %{USER:user}\[[^\]]+\] @ %{HOST:host} \[%{IP:ip}?]",
	          "^# Query_time: %{NUMBER:duration:float} \s*Lock_time: %{NUMBER:lock_wait:float} \s*Rows_sent: %{NUMBER:results:int} \s*Rows_examined: %{NUMBER:scanned:int}",
	          "^SET timestamp=%{NUMBER:timestamp};"
	        ]
	      }
	
	      multiline {
	        pattern => "^# User@Host: "
	        negate => true
	        what => previous
	      }
	
	      date {
	        match => ["timestamp", UNIX]
	      }
	
	      mutate {
	        remove => "timestamp"
	      }
	    }
	
	output {
	  stdout {
	    codec => rubydebug
	  }
	
	  elasticsearch {
	     host => "168.192.122.58"
	     protocol => "http"
	     workers => 5
	  }
	}



输入结果

![](http://i2.tietuku.com/cdeed3f95f3c62b5.png)


## 学习资料 ##

- [饶琛琳Github](https://github.com/chenryn/kibana)
- [饶琛琳Blog](http://chenlinux.com/)
- [Kibana 中文指南](http://chenryn.gitbooks.io/kibana-guide-cn/content/index.html)
- [Elasticsearch 权威指南](http://fuxiaopang.gitbooks.io/learnelasticsearch/)
- [logstash-grok-debug](https://grokdebug.herokuapp.com/)
- [logstash常用配置文件](https://github.com/shuge/man/tree/master/srv/log)
- [Logstash 最佳实践](https://github.com/chenryn/logstash-best-practice-cn)
- google

